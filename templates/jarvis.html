{% extends "base.html" %}

{% block head %}
<title>{{ active_chat.name or "MIRAI" }} - Mirai AI</title>
<link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
<style>
  /* ===== Theme variables ===== */
  :root{
    --bg: #ffffff;
    --surface: #ffffff;
    --muted: #6c757d;
    --text: #0f1720; /* darker for better contrast */
    --subtle: #6b7280;
    --chat-user-bg: #d1e7dd;
    --chat-bot-bg: #f1f5f9;
    --border: #e6e9ee;
    --accent: #0d6efd;
    --input-bg: #ffffff;
    --placeholder: #6c757d;
    --success: #198754;
    --glass: rgba(255,255,255,0.6);
  }
  body.dark-mode{
    --bg: #0f1113;
    --surface: #121314;
    --muted: #9aa4ab;
    --text: #e6edf3;
    --subtle: #94a3b8;
    --chat-user-bg: #083c2a;
    --chat-bot-bg: #171819;
    --border: #232426;
    --accent: #4ea3ff;
    --input-bg: #111213;
    --placeholder: #7f8b93;
    --success: #1fa266;
    --glass: rgba(18,19,20,0.6);
  }

  /* ----------------- Base Styles ----------------- */
  html, body { margin: 0; height: 100%; font-family: 'Segoe UI', Roboto, "Helvetica Neue", Arial, sans-serif; background: var(--bg); color: var(--text); transition: background-color .22s ease, color .22s ease; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }

  .chat-app { display: flex; height: 100vh; overflow: hidden; flex-direction: row; }

  /* -------- z-index strategy --------
     header: topmost
     sidebar: above overlay
     overlay: above main content
     chat-input: below overlay
  */
  .chat-header { z-index: 1600; position: sticky; top: 0; }
  .sidebar { z-index: 1550; }
  .sidebar-overlay { z-index: 1500; }

  /* Ensure overlay is hidden by default on desktop */
  .sidebar-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.45);
    z-index: 1500;
    pointer-events: none;
  }
  .sidebar-overlay.show { display: block; pointer-events: auto; }

  /* Make sidebar full-height and a proper flex column container */
  .sidebar {
    width: 280px; background: var(--surface); color: var(--text); padding: 1rem; border-right: 1px solid var(--border); transition: left .22s, width .22s, padding .18s, border-color .18s; flex-shrink: 0; display: flex; flex-direction: column; gap: 0.6rem; height: 100vh; overflow: hidden; box-sizing: border-box;
  }

  /* Let chat-list take remaining vertical space and scroll internally */
  .chat-list {
    margin-top: 0.6rem;
    display:flex;
    flex-direction:column;
    gap:0.5rem;
    padding-right: 6px;

    flex: 1 1 auto;          /* grow/shrink to fill available space */
    min-height: 0;           /* critical for flex children to allow overflow */
    overflow-y: auto;        /* internal scrollbar only */
    -webkit-overflow-scrolling: touch;
  }

  .sidebar > .d-flex,
  .sidebar > input.form-control {
    flex: 0 0 auto;
  }

  .sidebar h5 { margin: 0; font-size: 1.05rem; color: var(--text); font-weight:700; display:flex; align-items:center; gap:0.5rem }
  .sidebar .form-control { background: transparent; border: 1px solid var(--border); color: var(--text); padding: 0.45rem 0.6rem; border-radius: 10px; }
  .sidebar .form-control::placeholder { color: var(--placeholder); }

  .chat-form { width:100%; display:flex; align-items:center; justify-content:space-between; gap:0.5rem; }
  .chat-form button { width: 100%; display:flex; align-items:center; gap:10px; margin:0; background: transparent; color: var(--text); border: 1px solid transparent; padding: 0.55rem 0.8rem; text-align: left; border-radius: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: background .12s, border-color .12s; font-weight:600; }
  .chat-form button:hover { background: rgba(13,110,253,0.04); border-color: var(--border); }
  .chat-form button.active { background: linear-gradient(90deg, rgba(13,110,253,0.08), rgba(13,110,253,0.03)); border-color: rgba(13,110,253,0.12); }

  .chat-entry { width:100%; display:flex; align-items:center; gap:10px; }
  .chat-name { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

  .chat-main { flex-grow: 1; display: flex; flex-direction: column; background: var(--bg); min-width: 0; }

  .chat-header { padding: 0.9rem 1rem; border-bottom: 1px solid var(--border); background: linear-gradient(180deg, rgba(0,0,0,0.02), transparent); font-size: 1.05rem; font-weight: 700; display: flex; justify-content: space-between; align-items: center; gap: 0.75rem; flex-wrap: wrap; position: sticky; top: 0; z-index: 1600; }

  .chat-header .title { display:flex; align-items:center; gap:0.5rem; min-width: 0; color: var(--text); }
  .chat-header .title .name { font-size: 1rem; font-weight:800; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width: 48ch; }
  .chat-header .controls { display:flex; gap:0.5rem; align-items:center; }

  .control-btn { border: 1px solid var(--border); padding: 0.35rem 0.55rem; border-radius: 10px; background: transparent; cursor: pointer; font-size: 0.92rem; }
  .control-btn:focus { outline:2px solid rgba(13,110,253,0.12); outline-offset:2px; }

  .chat-box { flex-grow: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.75rem; min-height: 0; }

  .date-label { font-weight:700; color: var(--subtle); margin: 0.5rem auto; text-align: center; font-size: 0.85rem; background: transparent; padding: 0.25rem 0.6rem; border-radius: 999px; }

  .message { margin-bottom: 0; padding: 0.7rem 0.85rem; border-radius: 12px; max-width: 78%; word-wrap: break-word; animation: fadeIn .18s ease; color: var(--text); box-shadow: 0 1px 0 rgba(0,0,0,0.03); }
  .message.user { background-color: var(--chat-user-bg); align-self: flex-end; color: var(--text); }
  .message.bot { background-color: var(--chat-bot-bg); align-self: flex-start; color: var(--text); }

  .message .meta { font-size: 0.72rem; color: var(--subtle); margin-bottom: 0.35rem; display:flex; gap:0.5rem; align-items:center; }
  .message img.attachment-thumb { max-width: 220px; max-height: 160px; border-radius: 8px; display:block; margin-top:0.5rem; }
  .attachments { margin-top: 0.5rem; display:flex; gap:0.5rem; flex-wrap:wrap; }
  .attachment-pill { padding: 0.35rem 0.5rem; border-radius: 8px; border: 1px solid var(--border); background: transparent; font-size: 0.85rem; display:flex; gap:0.45rem; align-items:center; }

  /* ensure good contrast of message text */
  body.dark-mode .message.user, body.dark-mode .message.bot { color: var(--text); }

  /* chat input bar positioned relative with lower z-index than overlay */
  .chat-input-bar { display: flex; gap: 0.5rem; padding: 0.72rem; background: var(--surface); border-top: 1px solid var(--border); flex-wrap: wrap; align-items: center; position: relative; z-index: 1400; }

  .chat-input-bar input[type="text"], .chat-input-bar textarea { flex-grow: 1; border-radius: 999px; border: 1px solid var(--border); padding: 0.6rem 0.9rem; transition: background-color 0.18s, color 0.18s; min-width: 150px; background: var(--input-bg); color: var(--text); }
  .chat-input-bar input::placeholder { color: var(--placeholder); }

  .chat-input-bar .file-area { display:flex; align-items:center; gap:0.5rem; }
  .drop-zone { border: 1px dashed var(--border); padding: 0.5rem; border-radius: 8px; min-width: 90px; text-align:center; font-size:0.9rem; cursor:pointer; }
  .drop-zone.dragover { background: rgba(13,110,253,0.04); border-color: var(--accent); }
  .attachments-preview { display:flex; gap:0.5rem; align-items:center; }
  .preview-item { display:flex; gap:0.4rem; align-items:center; padding:0.25rem 0.4rem; border-radius:8px; border:1px solid var(--border); background:transparent; }
  .preview-item img { max-width:48px; max-height:36px; object-fit:cover; border-radius:6px }
  .preview-remove { cursor:pointer; font-weight:700; padding:2px 6px; border-radius:6px; }

  .chat-input-bar button.send-btn { border-radius: 10px; padding: 0.55rem 0.9rem; border: none; background: var(--accent); color: #fff; cursor:pointer; font-weight:700; }
  .chat-input-bar button.send-btn[disabled] { opacity:0.5; cursor:not-allowed }

  /* typing animation */
  .typing { opacity: .95; position: relative; }
  .typing span::after { content: ''; display:inline-block; width:6px; height:6px; margin-left:6px; vertical-align:middle; border-radius:50%; background:currentColor; animation: blink 1s infinite; opacity:.85; }
  @keyframes blink { 0% { transform: scale(1); opacity:1 } 50% { transform: scale(.6); opacity:.4 } 100% { transform: scale(1); opacity:1 } }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

  /* Modal */
  .modal { display: none; position: fixed; z-index: 1700; left: 0; top: 0; width: 100%; height: 100%; animation: fadeIn 0.15s ease; background-color: rgba(0, 0, 0, 0.45); align-items:center; justify-content:center; padding: 1rem; }
  .modal.show { display:flex; }
  .modal-content { background: var(--surface); margin: auto; padding: 18px; border: 1px solid var(--border); width: 100%; max-width: 520px; border-radius: 12px; box-shadow: 0 6px 30px rgba(0,0,0,0.12); }
  .modal-content h5 { margin-top: 0; }

  .chat-options { cursor:pointer; color:var(--subtle); font-size: 18px; margin-left: 8px; }
  .chat-options:hover { color: var(--text); }

  /* ----------------- Responsive ----------------- */
  @media (max-width: 768px) {
    .chat-app { flex-direction: column; }
    .sidebar { position: fixed; top: 0; left: -340px; height: 100%; width: 280px; z-index: 1550; box-shadow: 8px 0 30px rgba(0,0,0,0.12); transition: left .22s cubic-bezier(.2,.9,.2,1); }
    .sidebar.show { left: 0; }
    .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.45); z-index: 1500; pointer-events: none; }
    .sidebar-overlay.show { display:block; pointer-events: auto; }
    .sidebar { overflow-y: auto; padding: 1rem; border-right: none; border-bottom: 1px solid var(--border); }
    .chat-header { font-size: 1rem; padding: 0.6rem; }
    .chat-input-bar input { flex: 1 1 60%; min-width: 120px; }
    #sidebarToggle { display: inline-flex; }
  }

  @media (max-width: 480px) {
    .chat-input-bar input { padding: 0.45rem 0.6rem; }
    .sidebar button { font-size: 0.9rem; padding: 0.45rem 0.5rem; }
    .message { max-width: 95%; padding: 0.55rem 0.7rem; }
    .chat-header .controls { gap: 0.25rem; }
    .chat-header .title .name { max-width: 22ch; }
  }

  /* ---------- Desktop collapsible sidebar support ---------- */
  /* show toggle on larger screens too (we still keep mobile slide-over) */
  #sidebarToggle { display: inline-flex; }

  /* collapsed sidebar state for desktop */
  .chat-app.sidebar-collapsed .sidebar {
    width: 0;
    min-width: 0;
    padding: 0;
    border-right: none;
    overflow: hidden;
    transition: width .24s cubic-bezier(.2,.9,.2,1), padding .18s, border-color .18s;
    box-shadow: none;
    pointer-events: none;
  }

  /* give main chat area some horizontal breathing room when sidebar hidden */
  .chat-app.sidebar-collapsed .chat-main {
    padding-left: 0;
    padding-right: 0;
    transition: padding .24s;
  }

  @media (min-width: 1400px) {
    .chat-app.sidebar-collapsed .chat-main { padding-left: 1.6rem; padding-right: 1.6rem; }
  }

  /* Improve mobile button visibility and layout */
  @media (max-width: 768px) {
    .chat-app { flex-direction: column; }
    .sidebar { position: fixed; top: 0; left: -340px; height: 100%; width: 280px; z-index: 1550; box-shadow: 8px 0 30px rgba(0,0,0,0.12); transition: left .22s cubic-bezier(.2,.9,.2,1); }
    .sidebar.show { left: 0; }
    .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.45); z-index: 1500; pointer-events: none; }
    .sidebar-overlay.show { display:block; pointer-events: auto; }
    .sidebar { overflow-y: auto; padding: 1rem; border-right: none; border-bottom: 1px solid var(--border); }
    .chat-header { font-size: 1rem; padding: 0.6rem; }

    /* make header controls wrap so icons remain visible */
    .chat-header .controls { display:flex; gap:0.35rem; align-items:center; flex-wrap:wrap; }
    .chat-header .controls .control-btn, .chat-header .controls a.control-btn { padding: 0.45rem 0.5rem; font-size: 0.98rem; }

    /* make sidebar toggle more prominent */
    #sidebarToggle { font-size: 1.05rem; padding: 0.35rem 0.5rem; }

    /* chat input tweaks for mobile */
    .chat-input-bar { padding: 0.5rem; }
    .chat-input-bar button.send-btn { padding: 0.48rem 0.7rem; font-size: 0.95rem; }

    #sidebarToggle { display: inline-flex; }
  }
</style>
{% endblock %}

{% block content %}
<div class="chat-app" aria-live="polite">
  <!-- Sidebar Overlay for mobile -->
  <div id="sidebarOverlay" class="sidebar-overlay" aria-hidden="true"></div>

  <!-- Sidebar -->
  <aside class="sidebar" aria-label="Chats sidebar">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5>üí¨ Chats</h5>
      <form method="POST" action="{{ url_for('app_routes.new_chat') }}" style="margin:0">
        <button type="submit" class="btn" title="New chat" aria-label="Create new chat">‚ûï</button>
      </form>
    </div>
    <input type="text" id="chatSearch" class="form-control form-control-sm" placeholder="Search chats..." aria-label="Search chats">
    <div class="chat-list flex-grow-1">
      {% for chat in chats %}
      <form method="GET" action="{{ url_for('app_routes.jarvis') }}" class="chat-form" data-chat-id="{{ chat.id }}">
        <input type="hidden" name="chat_id" value="{{ chat.id }}">
        <div class="chat-entry" data-chat-id="{{ chat.id }}">
          <button type="submit" class="{% if active_chat and chat.id == active_chat.id %}active{% endif %}" aria-label="Open chat {{ chat.name }}">
            üó®Ô∏è <span class="chat-name">{{ chat.name }}</span>
          </button>
          <span class="chat-options" title="Options" role="button" tabindex="0">‚ãÆ</span>
        </div>
      </form>
      {% endfor %}
    </div>
  </aside>

  <!-- Chat Main -->
  <main class="chat-main" role="main">
    <header class="chat-header">
      <div class="title">
        <button id="sidebarToggle" class="control-btn" aria-label="Toggle sidebar" aria-pressed="false">‚ò∞</button>
        <div class="name" title="{{ active_chat.name or 'Chat with Mirai AI' }}">ü§ñ {{ active_chat.name or "Chat with Mirai AI" }}</div>
      </div>

      <div class="controls">
        <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="Search messages..." aria-label="Search messages" />
        <button id="exportBtn" type="button" class="control-btn" title="Export chat">‚¨áÔ∏è</button>
        <button id="settingsBtn" type="button" class="control-btn" title="Voice settings">‚öôÔ∏è</button>
        <button id="themeToggle" type="button" class="control-btn" title="Toggle theme">üåô</button>
        <a class="control-btn" href="/logout" title="Logout">Logout</a>
      </div>
    </header>

    <div id="chatContainer" class="chat-box" aria-live="polite" aria-atomic="false">
      {% set prev_date = None %}
      {% for m in messages %}
      {% set msg_date = m.timestamp.strftime('%Y-%m-%d') %}
      {% if msg_date != prev_date %}
      <div class="date-label">{{ msg_date }}</div>
      {% set prev_date = msg_date %}
      {% endif %}
      <div class="message {{ 'user' if m.sender == 'user' else 'bot' }}" data-msg-id="{{ m.id }}">
        <div class="meta"><strong>{{ 'üßë You' if m.sender == 'user' else 'ü§ñ Mirai' }}</strong><span>{{ m.timestamp.strftime('%H:%M') }}</span></div>
        <div class="body">{{ m.content }}</div>
        {% if m.attachments %}
        <div class="attachments">
          {% for a in m.attachments %}
            {% if a.content_type.startswith('image') %}
              <a href="{{ url_for('app_routes.serve_file', file_id=a.id) }}" target="_blank" rel="noopener" aria-label="Open attachment {{ a.filename }}">
                <img class="attachment-thumb" src="{{ url_for('app_routes.serve_file', file_id=a.id) }}" alt="{{ a.filename }}">
              </a>
            {% else %}
              <a class="attachment-pill" href="{{ url_for('app_routes.serve_file', file_id=a.id) }}" target="_blank" rel="noopener">üìé {{ a.filename }}</a>
            {% endif %}
          {% endfor %}
        </div>
        {% endif %}
      </div>
      {% endfor %}
    </div>

    <form id="sendForm" class="chat-input-bar" aria-label="Send a message" enctype="multipart/form-data" method="post" action="{{ url_for('app_routes.send_message', chat_id=active_chat.id if active_chat else '') }}">
      <input type="text" id="userInput" name="message" placeholder="Type your message..." autocomplete="off" required aria-label="Message input">

      <div class="file-area" role="group" aria-label="File attachments">
        <label class="drop-zone" id="dropZone" tabindex="0" aria-label="Attach files or drop here">üìé Attach</label>
        <input type="file" id="fileInput" name="files" multiple style="display:none" aria-hidden="true">
        <div class="attachments-preview" id="attachmentsPreview" aria-live="polite"></div>
      </div>

      <div style="display:flex; gap:0.4rem; align-items:center;">
        <button type="submit" id="sendBtn" class="send-btn" aria-label="Send message" disabled>üì© Send</button>
        <button type="button" id="micBtn" class="control-btn" aria-pressed="false" aria-label="Start voice input">üé§</button>
        <button type="button" id="speakBtn" class="control-btn" aria-label="Speak last reply">üîä</button>
      </div>
    </form>

    <!-- Modals -->
    <div id="settingsModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="modal-content">
        <button id="closeModal" style="float:right; cursor:pointer; background:none; border:none; font-size:18px;" aria-label="Close">√ó</button>
        <h5>üó£Ô∏è Voice Settings</h5>
        <label for="voiceSelect">Select Voice:</label>
        <select id="voiceSelect" class="form-select mt-2" aria-label="Voice select"></select>
      </div>
    </div>

    <div id="chatModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="modal-content">
        <button id="closeChatModal" style="float:right; cursor:pointer; background:none; border:none; font-size:18px;" aria-label="Close">√ó</button>
        <h5>Chat Options</h5>
        <input type="text" id="renameInput" class="form-control mt-2 mb-2" placeholder="New chat name" aria-label="New chat name">
        <button id="renameBtn" class="btn btn-primary btn-sm w-100">Rename</button>
        <button id="deleteBtn" class="btn btn-danger btn-sm w-100 mt-2">Delete</button>
      </div>
    </div>
  </main>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const chatBox = document.getElementById('chatContainer');
  const form = document.getElementById('sendForm');
  const input = document.getElementById('userInput');
  const searchInput = document.getElementById('searchInput');
  const chatSearch = document.getElementById('chatSearch');
  const exportBtn = document.getElementById('exportBtn');
  const chatId = "{{ active_chat.id if active_chat else '' }}";
  chatBox.scrollTop = chatBox.scrollHeight;
  let selectedChatId = null;
  input.focus();

  // attachments state
  const fileInput = document.getElementById('fileInput');
  const dropZone = document.getElementById('dropZone');
  const attachmentsPreview = document.getElementById('attachmentsPreview');
  let pendingUploads = []; // { tempId, filename, size, content_type, id?, url? }

  // -------- sidebar toggle (mobile + desktop collapse) --------
  const sidebarToggle = document.getElementById('sidebarToggle');
  const sidebar = document.querySelector('.sidebar');
  const sidebarOverlay = document.getElementById('sidebarOverlay');
  const chatApp = document.querySelector('.chat-app');

  // restore collapsed state from localStorage
  const savedCollapsed = localStorage.getItem('mirai_sidebar_collapsed');
  if (savedCollapsed === 'true') chatApp.classList.add('sidebar-collapsed');

  const MOBILE_BREAK = 768;
  function isMobile() { return window.innerWidth <= MOBILE_BREAK; }

  function openSidebarMobile() {
    sidebar.classList.add('show');
    sidebarOverlay.classList.add('show');
    sidebarOverlay.setAttribute('aria-hidden','false');
    document.body.style.overflow = 'hidden'; // lock background scroll
    sidebar.setAttribute('aria-hidden', 'false');
  }
  function closeSidebarMobile() {
    sidebar.classList.remove('show');
    sidebarOverlay.classList.remove('show');
    sidebarOverlay.setAttribute('aria-hidden','true');
    document.body.style.overflow = ''; // restore scroll
    sidebar.setAttribute('aria-hidden', 'true');
  }

  function openSidebarDesktop() {
    chatApp.classList.remove('sidebar-collapsed');
    sidebar.classList.remove('show');
    sidebarOverlay.classList.remove('show');
    sidebarOverlay.setAttribute('aria-hidden','true');
    sidebarToggle.setAttribute('aria-pressed','false');
    sidebarToggle.textContent = '‚ò∞';
    localStorage.setItem('mirai_sidebar_collapsed','false');
  }
  function closeSidebarDesktop() {
    chatApp.classList.add('sidebar-collapsed');
    sidebar.classList.remove('show');
    sidebarOverlay.classList.remove('show');
    sidebarOverlay.setAttribute('aria-hidden','true');
    sidebarToggle.setAttribute('aria-pressed','true');
    sidebarToggle.textContent = '‚ò∑';
    localStorage.setItem('mirai_sidebar_collapsed','true');
  }

  function setSidebarVisible(visible){
    if(isMobile()){
      if(visible) openSidebarMobile(); else closeSidebarMobile();
    } else {
      if(visible) openSidebarDesktop(); else closeSidebarDesktop();
    }
  }

  function applyInitialSidebarState(){
    // ensure toggle visible
    sidebarToggle.style.display = 'inline-flex';
    if(isMobile()){
      // on mobile, always start closed
      closeSidebarMobile();
      chatApp.classList.remove('sidebar-collapsed');
    } else {
      // desktop: restore saved collapsed state
      const saved = localStorage.getItem('mirai_sidebar_collapsed') === 'true';
      if(saved) closeSidebarDesktop(); else openSidebarDesktop();
      // ensure overlay hidden
      sidebarOverlay.classList.remove('show');
    }
    // keep toggle aria-pressed in sync
    const collapsed = chatApp.classList.contains('sidebar-collapsed');
    sidebarToggle.setAttribute('aria-pressed', collapsed ? 'true' : 'false');
    sidebarToggle.textContent = collapsed ? '‚ò∑' : '‚ò∞';
  }

  applyInitialSidebarState();
  window.addEventListener('resize', applyInitialSidebarState);

  sidebarToggle.onclick = () => {
    if(isMobile()){
      setSidebarVisible(!sidebar.classList.contains('show'));
    } else {
      setSidebarVisible(!chatApp.classList.contains('sidebar-collapsed'));
    }
    sidebarToggle.focus();
  };

  sidebarOverlay.onclick = () => setSidebarVisible(false);
  // When selecting a chat on mobile, hide the sidebar
  document.querySelectorAll('.chat-form button[type="submit"]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(isMobile()) setSidebarVisible(false);
    });
  });

  // Chat options (rename/delete)
  document.querySelectorAll('.chat-options').forEach(dot => {
    dot.addEventListener('click', (e) => {
      e.preventDefault();
      const entry = dot.closest('.chat-entry');
      selectedChatId = entry ? entry.getAttribute('data-chat-id') : null;
      document.getElementById('renameInput').value = entry ? entry.querySelector('.chat-name').textContent.trim() : '';
      const cm = document.getElementById('chatModal');
      cm.classList.add('show'); cm.setAttribute('aria-hidden','false');
    });
    dot.addEventListener('keydown', (e) => { if(e.key === 'Enter' || e.key === ' ') dot.click(); });
  });

  document.getElementById('closeChatModal').onclick = () => { const cm = document.getElementById('chatModal'); cm.classList.remove('show'); cm.setAttribute('aria-hidden','true'); };
  document.getElementById('closeModal').onclick = () => { const cm = document.getElementById('settingsModal'); cm.classList.remove('show'); cm.setAttribute('aria-hidden','true'); };

  document.getElementById('renameBtn').onclick = async () => {
    const newName = document.getElementById('renameInput').value.trim();
    if (!newName || !selectedChatId) return;
    try {
      const res = await fetch(`/rename_chat/${encodeURIComponent(selectedChatId)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: newName })
      });
      if (!res.ok) throw new Error('Network error');
      const data = await res.json();
      const entry = document.querySelector(`.chat-entry[data-chat-id="${selectedChatId}"]`);
      if (entry) {
        const nameEl = entry.querySelector('.chat-name');
        if (nameEl) nameEl.textContent = (data && data.name) ? data.name : newName;
      }
      if (String(selectedChatId) === String(chatId)) {
        const headerName = document.querySelector('.chat-header .name');
        const display = (data && data.name) ? data.name : newName;
        if (headerName) {
          headerName.textContent = 'ü§ñ ' + display;
          headerName.setAttribute('title', display);
        }
        try { document.title = `${display} - Mirai AI`; } catch(e){}
      }
      const cm = document.getElementById('chatModal');
      if (cm) { cm.classList.remove('show'); cm.setAttribute('aria-hidden','true'); }
    } catch (err) {
      alert("Could not rename chat.");
      console.error(err);
    }
  };

  document.getElementById('deleteBtn').onclick = async () => {
    if (!selectedChatId) return;
    if (!confirm("Are you sure you want to delete this chat?")) return;
    try {
      const res = await fetch(`/delete_chat/${encodeURIComponent(selectedChatId)}`, { method: 'POST' });
      if (!res.ok) throw new Error('Network error');
      const data = await res.json();
      if (data && data.redirect) {
        window.location.href = data.redirect;
      } else {
        // fallback: reload
        window.location.reload();
      }
    } catch (err) {
      alert("Could not delete chat.");
      console.error(err);
    }
  };

  // --------- UI message helper (safe) ---------
  function renderAttachmentsEls(attachments){
    if(!attachments || attachments.length===0) return null;
    const container = document.createElement('div'); container.className = 'attachments';
    attachments.forEach(a => {
      if(a.content_type && a.content_type.startsWith('image')){
        const aEl = document.createElement('a'); aEl.href = a.url || '#'; aEl.target = '_blank'; aEl.rel='noopener';
        const img = document.createElement('img'); img.className = 'attachment-thumb'; img.src = a.url || a.previewUrl || ''; img.alt = a.filename || 'attachment';
        aEl.appendChild(img); container.appendChild(aEl);
      } else {
        const link = document.createElement('a'); link.className = 'attachment-pill'; link.href = a.url || '#'; link.target='_blank'; link.rel='noopener'; link.textContent = 'üìé ' + (a.filename || 'file'); container.appendChild(link);
      }
    });
    return container;
  }

  function appendMessage({text, who='bot', typing=false, attachments=null}){
    const wrapper = document.createElement('div');
    wrapper.className = 'message ' + (who === 'user' ? 'user' : 'bot') + (typing ? ' typing' : '');
    const meta = document.createElement('div'); meta.className = 'meta';
    const strong = document.createElement('strong'); strong.textContent = who === 'user' ? 'üßë You' : 'ü§ñ Mirai';
    const time = document.createElement('span'); time.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    meta.appendChild(strong); meta.appendChild(time);
    const body = document.createElement('div'); body.className = 'body'; body.textContent = text;
    wrapper.appendChild(meta); wrapper.appendChild(body);
    if(attachments && attachments.length){
      const at = renderAttachmentsEls(attachments);
      if(at) wrapper.appendChild(at);
    }
    chatBox.appendChild(wrapper);
    chatBox.scrollTop = chatBox.scrollHeight;
    return { wrapper, body };
  }

  // submit handler (supports attachments)
  const sendBtnElem = document.getElementById('sendBtn');
  function updateSendButton(){ sendBtnElem.disabled = !input.value.trim() && pendingUploads.length===0; }
  input.addEventListener('input', updateSendButton);

  form.addEventListener('submit', async e => {
    e.preventDefault();
    const text = input.value.trim();
    if (!text && pendingUploads.length===0) return;
    input.value = ''; updateSendButton();
    appendMessage({ text, who: 'user', attachments: pendingUploads });

    try {
      const typingMsg = appendMessage({ text: '', who: 'bot', typing: true });

      // Build payload: send attachments (already uploaded server-side) as ids when available
      const payload = { message: text, attachments: pendingUploads.map(a => ({ id: a.id, filename: a.filename })) };

      const endpoint = form.getAttribute('action') || (`/send_message/${encodeURIComponent(chatId)}`);
      const res = await fetch(endpoint, {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
      });

      if (!res.ok) throw new Error('Network error');

      const data = await res.json();

      // remove typing
      typingMsg.wrapper.classList.remove('typing');
      typingMsg.body.textContent = '';

      if (data && data.reply) {
        // typewriter effect
        let i = 0;
        const reply = String(data.reply);
        const interval = setInterval(()=>{
          if(i < reply.length){
            typingMsg.body.textContent += reply.charAt(i++);
            chatBox.scrollTop = chatBox.scrollHeight;
          } else {
            clearInterval(interval);
          }
        }, 14);
      } else {
        typingMsg.body.textContent = 'No reply.';
      }

      // clear attachments preview state
      pendingUploads = [];
      attachmentsPreview.innerHTML = '';
      updateSendButton();

    } catch (err) {
      appendMessage({ text: '‚ö†Ô∏è Error sending message.', who: 'bot' });
      console.error(err);
    }
  });

  // -------- attachments: drag/drop and upload --------
  function humanFileSize(bytes){ const units=['B','KB','MB','GB','TB']; let i=0; while(bytes>=1024 && i<units.length-1){ bytes/=1024; i++; } return `${Math.round(bytes*10)/10} ${units[i]}`; }

  dropZone.addEventListener('click', ()=> fileInput.click());
  dropZone.addEventListener('keydown', (e)=> { if(e.key==='Enter' || e.key===' ') fileInput.click(); });
  dropZone.addEventListener('dragover', (e)=>{ e.preventDefault(); dropZone.classList.add('dragover'); });
  dropZone.addEventListener('dragleave', ()=> dropZone.classList.remove('dragover'));
  dropZone.addEventListener('drop', (e)=>{ e.preventDefault(); dropZone.classList.remove('dragover'); const files = Array.from(e.dataTransfer.files || []); handleFiles(files); });
  fileInput.addEventListener('change', (e)=> handleFiles(Array.from(e.target.files || [])));

  function createPreviewItem(file, tempId){
    const wrap = document.createElement('div'); wrap.className = 'preview-item'; wrap.setAttribute('data-temp-id', tempId);
    if(file.type && file.type.startsWith('image')){ const img = document.createElement('img'); img.src = URL.createObjectURL(file); wrap.appendChild(img); }
    const info = document.createElement('div'); info.style.display='flex'; info.style.flexDirection='column'; info.style.fontSize='0.85rem';
    const name = document.createElement('div'); name.textContent = file.name; const size = document.createElement('div'); size.textContent = humanFileSize(file.size);
    info.appendChild(name); info.appendChild(size); wrap.appendChild(info);
    const rem = document.createElement('div'); rem.className = 'preview-remove'; rem.title='Remove'; rem.textContent='‚úñ'; rem.style.marginLeft='6px'; rem.addEventListener('click', ()=> removePreview(tempId)); wrap.appendChild(rem);
    attachmentsPreview.appendChild(wrap);
  }

  function removePreview(tempId){
    const idx = pendingUploads.findIndex(p => p.tempId === tempId && !p.id);
    if(idx !== -1){ pendingUploads.splice(idx,1); }
    const el = attachmentsPreview.querySelector(`[data-temp-id='${tempId}']`);
    if(el) el.remove(); updateSendButton();
  }

  function handleFiles(files){
    files.forEach(file => {
      const tempId = 't_' + Math.random().toString(36).slice(2,9);
      pendingUploads.push({ tempId, filename: file.name, size: file.size, content_type: file.type });
      createPreviewItem(file, tempId);
      uploadFile(file, tempId);
    });
    updateSendButton();
  }

  function uploadFile(file, tempId){
    const url = `/upload_file/${encodeURIComponent(chatId)}`;
    const formData = new FormData(); formData.append('file', file);
    const xhr = new XMLHttpRequest(); xhr.open('POST', url);
    xhr.onload = () => {
      if(xhr.status >= 200 && xhr.status < 300){
        try{
          const j = JSON.parse(xhr.responseText);
          if(j && j.file){
            const idx = pendingUploads.findIndex(p => p.tempId === tempId);
            if(idx !== -1){ pendingUploads[idx] = Object.assign(pendingUploads[idx], j.file); }
            const el = attachmentsPreview.querySelector(`[data-temp-id='${tempId}']`);
            if(el) el.setAttribute('data-file-id', j.file.id);
            updateSendButton();
          }
        }catch(e){ console.error('Invalid upload response', e); }
      } else {
        console.error('Upload failed', xhr.statusText);
        const idx = pendingUploads.findIndex(p => p.tempId === tempId);
        if(idx!==-1) pendingUploads[idx].error = true;
      }
    };
    xhr.onerror = () => { console.error('Upload error'); };
    xhr.send(formData);
  }

  // ---- search within messages and chats ----
  searchInput.addEventListener('input', () => {
    const term = searchInput.value.trim().toLowerCase();
    document.querySelectorAll('.message').forEach(m => {
      m.style.display = (term === '' || m.innerText.toLowerCase().includes(term)) ? '' : 'none';
    });
  });
  chatSearch.addEventListener('input', () => {
    const term = chatSearch.value.trim().toLowerCase();
    document.querySelectorAll('.chat-form').forEach(form => {
      const nameEl = form.querySelector('.chat-name');
      const name = nameEl ? nameEl.textContent.toLowerCase() : '';
      form.style.display = (term === '' || name.includes(term)) ? '' : 'none';
    });
  });

  // ---- export chat ----
  exportBtn.addEventListener('click', () => {
    const messages = [...document.querySelectorAll('.message')].map(m => {
      const txt = m.querySelector('.body') ? m.querySelector('.body').innerText.trim() : m.innerText.trim();
      const atEls = Array.from(m.querySelectorAll('.attachment-pill')).map(a=>a.innerText.trim());
      return { text: txt, attachments: atEls };
    });
    const format = prompt("Export as: txt / json / md")?.toLowerCase(); if (!format) return;
    let content = "", type = "text/plain", ext = "txt";
    if (format === "json") { content = JSON.stringify(messages, null, 2); type = "application/json"; ext = "json"; }
    else if (format === "md") { content = messages.map(m => `- ${m.text}${m.attachments.length? ' \\n  - ' + m.attachments.join('\\n  - '): ''}`).join("\\n\\n"); ext = "md"; }
    else { content = messages.map(m => `${m.text}${m.attachments.length? '\\nAttachments: ' + m.attachments.join(', '): ''}`).join("\\n\\n"); }
    const blob = new Blob([content], { type }); const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `mirai_chat.${ext}`; document.body.appendChild(a); a.click(); a.remove();
  });

  // Theme toggle (persist)
  const themeToggle = document.getElementById('themeToggle');
  const savedTheme = localStorage.getItem('mirai_theme');
  if (savedTheme === 'dark') document.body.classList.add('dark-mode');
  function toggleTheme(){
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('mirai_theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
  }
  themeToggle.addEventListener('click', toggleTheme);

  // Settings modal (voice) opener
  const settingsBtn = document.getElementById('settingsBtn');
  settingsBtn.addEventListener('click', () => {
    const modal = document.getElementById('settingsModal');
    modal.classList.add('show'); modal.setAttribute('aria-hidden','false');
    // populate voices if using Web Speech API (graceful fallback)
    try {
      const synth = window.speechSynthesis;
      const select = document.getElementById('voiceSelect');
      function populateVoices(){
        const voices = synth.getVoices();
        select.innerHTML = '';
        voices.forEach(v => {
          const opt = document.createElement('option'); opt.value = v.name; opt.textContent = `${v.name} (${v.lang})`;
          select.appendChild(opt);
        });
      }
      populateVoices();
      synth.onvoiceschanged = populateVoices;
    } catch(e){ /* no-op */ }
  });

  // speak last bot reply
  const speakBtn = document.getElementById('speakBtn');
  speakBtn.addEventListener('click', () => {
    try {
      const lastBot = Array.from(document.querySelectorAll('.message.bot .body')).pop();
      if (!lastBot) return alert('No bot reply to speak.');
      const text = lastBot.innerText.trim();
      if (!text) return;
      if ('speechSynthesis' in window){
        const utter = new SpeechSynthesisUtterance(text);
        const sel = document.getElementById('voiceSelect');
        if(sel && sel.value){
          const v = window.speechSynthesis.getVoices().find(x=>x.name === sel.value);
          if(v) utter.voice = v;
        }
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utter);
      } else {
        alert('Text-to-speech not supported in this browser.');
      }
    } catch(err){ console.error(err); }
  });

  // basic mic voice-to-text (optional; requires getUserMedia + SpeechRecognition)
  const micBtn = document.getElementById('micBtn');
  let recognition = null;
  try {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
      recognition = new SpeechRecognition();
      recognition.lang = 'en-US';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.onresult = (ev) => {
        const txt = ev.results[0][0].transcript || '';
        input.value = input.value ? (input.value + ' ' + txt) : txt;
        updateSendButton();
      };
      recognition.onerror = (ev) => { console.error('Speech recognition error', ev); };
    }
  } catch(e){
    recognition = null;
  }
  micBtn.addEventListener('click', () => {
    if (!recognition) return alert('Speech recognition not supported in this browser.');
    if (micBtn.getAttribute('aria-pressed') === 'true') {
      recognition.stop(); micBtn.setAttribute('aria-pressed', 'false'); micBtn.textContent = 'üé§';
    } else {
      recognition.start(); micBtn.setAttribute('aria-pressed', 'true'); micBtn.textContent = '‚èπ';
      recognition.onend = () => { micBtn.setAttribute('aria-pressed','false'); micBtn.textContent = 'üé§'; };
    }
  });

});
</script>
{% endblock %}
